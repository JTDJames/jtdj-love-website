<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pinky Swear | jtdj.love</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg: #fdf6e3; --text: #586e75; --accent: #d33682; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; text-align: center; overflow-x: hidden; }
        .container { background: white; padding: 2.5rem; border-radius: 35px; box-shadow: 0 15px 40px rgba(0,0,0,0.04); max-width: 500px; width: 90%; position: relative; z-index: 10; }
        
        #statusNote { font-size: 0.75rem; color: #aaa; margin-top: 15px; }
        #statusNote a { color: var(--accent); text-decoration: none; font-weight: bold; }

        .animation-area { height: 260px; position: relative; margin: 10px 0; display: flex; justify-content: center; align-items: center; }

        /* --- STATE MACHINE CSS --- */

        /* 1. Default/Initial: Hands are prepared but stationary */
        #left-hand, #right-hand { transition: all 1s ease-in-out; }
        #sparkles { opacity: 0; transform: scale(0.5); transform-origin: center; }

        /* 2. Sender State: Only the pink hand (left) is extended and waiting */
        .waiting-sender #left-hand { transform: translateX(40px) rotate(0deg); }
        .waiting-sender #right-hand { transform: translateX(250px); opacity: 0; }

        /* 3. Recipient Invitation: Both hands are apart, reaching out */
        .invitation #left-hand { transform: translateX(-80px) rotate(-10deg); }
        .invitation #right-hand { transform: translateX(80px) rotate(10deg); opacity: 1; }

        /* 4. Accepted State: The Animation triggers */
        .accepted #left-hand { animation: joinLeft 2s ease-in-out forwards; }
        .accepted #right-hand { opacity: 1; animation: joinRight 2s ease-in-out forwards; }
        .accepted #sparkles { animation: popIn 2.2s forwards; }

        @keyframes joinLeft { 0% { transform: translateX(-80px) rotate(-10deg); } 80%, 100% { transform: translateX(0px) rotate(0deg); } }
        @keyframes joinRight { 0% { transform: translateX(80px) rotate(10deg); } 80%, 100% { transform: translateX(0px) rotate(0deg); } }
        @keyframes popIn { 0%, 75% { opacity: 0; transform: scale(0.2); } 85% { opacity: 1; transform: scale(1.1); } 100% { opacity: 1; transform: scale(1); } }

        /* Sparkle Twinkle (Low Impact) */
        .sparkle-anim-1 { animation: twinkle-1 3s infinite alternate ease-in-out; transform-box: fill-box; transform-origin: center; }
        @keyframes twinkle-1 { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(0.7); opacity: 0.5; } }

        button { background-color: var(--accent); color: white; border: none; padding: 16px 38px; border-radius: 50px; font-weight: 700; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 15px rgba(211, 54, 130, 0.25); }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(211, 54, 130, 0.35); }

        /* Floating Copy UI for Sender */
        #shareOverlay { display: none; position: fixed; bottom: 30px; background: #333; color: white; padding: 12px 20px; border-radius: 50px; align-items: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 100; font-size: 0.85rem; }
    </style>
</head>
<body>

<div class="container" id="mainContainer">
    <div id="loading">Gathering the promise...</div>
    <div id="content" style="display: none;">
        <h2 id="titleText"></h2>
        <p id="promiseText"></p>
        
        <div class="animation-area">
             <svg id="pinky-promise-animation" viewBox="-200 -50 912 612" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
                <g id="sparkle-positioner" transform="translate(110, -10) scale(0.6)">
                    <g id="sparkles">
                        <g class="sparkle-anim-1">
                            <path style="fill:#F9D366;" d="M284.682,405.593l6.398-1.297c8.444-1.712,8.444-13.781,0-15.493l-6.398-1.297c-16.119-3.268-28.717-15.866-31.985-31.985l-1.297-6.398c-1.712-8.444-13.781-8.444-15.493,0l-1.297,6.398c-3.268,16.119-15.866,28.717-31.985,31.985l-6.398,1.297c-8.444,1.712-8.444,13.781,0,15.493l6.398,1.297c16.119,3.268,28.717,15.866,31.985,31.985l1.297,6.398c1.712,8.444,13.781,8.444,15.493,0l1.297-6.398C255.965,421.459,268.563,408.861,284.682,405.593z"/>
                        </g>
                    </g>
                </g>
                <g id="right-hand">
                    <path d="m503.74 225.084 2.568 7.055c7.095 19.494 6.745 40.914-.989 60.154l-13.277 33.115 19.342 53.141c1.91 5.247-.796 11.05-6.043 12.96l-129.936 47.293c-5.247 1.91-11.05-.796-12.96-6.043l-19.342-53.141-26.907-29.395c-11.491-12.568-20.408-27.265-26.232-43.269l-73.894-202.99c-2.208-6.065-1.748-12.451.783-17.879 2.572-5.516 7.294-10.037 13.53-12.2 12.144-4.211 25.396 2.508 29.792 14.587l37.849 103.991 15.558 11.677 122.654-41.888 28.09 77.177z" fill="#d68a5a"/>
                    <path d="m288.072 165.129-24.864 68.31-39.28-107.903 15.354-42.197c1.302-3.573 3.125-6.854 5.364-9.781 6.864 2.031 12.708 7.177 15.343 14.416z" fill="#c47a4a"/>
                    <path d="m436.237 162.252 14.26 39.179-36.349 13.23c-.479 1.862-1.092 3.687-1.864 5.474-4.318 9.26-11.947 16.242-21.513 19.724-8.268 3.009-16.913 2.962-24.702.435-4.352 6.947-10.941 12.55-19.209 15.559-19.739 7.184-41.64-3.028-48.824-22.767l-15.011-41.243c-4.175-11.471-2.481-23.668 3.55-33.286l18.393 50.533z" fill="#c47a4a"/>
                    <path d="m437.558 165.858-13.537-37.192c-4.414-12.128-17.825-18.381-29.953-13.967s-18.381 17.825-13.967 29.953l13.537 37.192z" fill="#d68a5a"/>
                </g>
                <g id="left-hand">
                    <path d="m8.26 225.084-2.568 7.055c-7.095 19.494-6.745 40.914.989 60.154l13.277 33.115-19.341 53.141c-1.91 5.247.796 11.05 6.043 12.96l129.936 47.293c5.247 1.91 11.05-.796 12.96-6.043l19.342-53.141 26.907-29.395c11.491-12.568 20.408-27.265 26.232-43.269l73.894-202.99c2.208-6.065 1.748-12.451-.783-17.879-2.572-5.516-7.294-10.037-13.53-12.2-12.144-4.211-25.396 2.508-29.792 14.587l-37.169 102.121-16.239 13.547-122.655-41.888-28.09 77.177z" fill="#fdd1a7"/>
                    <path d="m295.925 103.962-73.894 202.99c-5.825 16.004-14.741 30.701-26.232 43.269l-26.907 29.395-19.342 53.141-12.96 6.043l-11.418-4.156 22.8-62.642 26.907-29.395c11.491-12.568 20.408-27.265 26.232-43.269l73.894-202.99c2.208-6.065 1.748-12.451-.783-17.879 11.42 1.168 13.186 12.078 2.531 5.428z" fill="#ffbc8a"/>
                    <path d="m74.442 165.858 13.537-37.192c4.414-12.128 17.825-18.381 29.953-13.967s18.381 17.825 13.967 29.953l-13.537 37.192z" fill="#ffe5c4"/>
                </g>
            </svg>
        </div>
        
        <button id="actionBtn" onclick="acceptPromise()">Pinky Promise</button>
        <div id="statusNote">Connecting...</div>
    </div>
</div>

<div id="shareOverlay">
    <span>Ready to send?</span>
    <button onclick="copyRecipientLink()" style="background:var(--accent); color:white; border:none; border-radius:20px; margin-left:12px; padding:6px 15px; cursor:pointer; font-weight:bold;">Copy Recipient Link</button>
</div>

<script>
    const supabaseUrl = 'https://euollkzgqskcehpryzvk.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV1b2xsa3pncXNrY2VocHJ5enZrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyNTY2MDYsImV4cCI6MjA4NzgzMjYwNn0.Vl-X_vrbaWlMUh_OeJe5tbHvcxkt_j4bjHMIZpRJZrc';
    const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

    let currentPromise = null;
    let pollCount = 0;

    async function loadPromise() {
        const urlParams = new URLSearchParams(window.location.search);
        const slug = urlParams.get('id');
        const role = urlParams.get('role');

        const { data } = await supabaseClient.from('promises').select('*').eq('slug', slug).single();

        if (data) {
            currentPromise = data;
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';
            
            // Handle Share Overlay for new Senders
            if (urlParams.get('new') === 'true' && role === 's' && !currentPromise.is_accepted) {
                document.getElementById('shareOverlay').style.display = 'flex';
            }

            updateUI(role);
            if (currentPromise.is_accepted) return true; // Stop polling
        }
        return false;
    }

    function updateUI(role) {
        const container = document.getElementById('mainContainer');
        const title = document.getElementById('titleText');
        const btn = document.getElementById('actionBtn');

        if (currentPromise.is_accepted) {
            container.className = "container accepted";
            title.innerText = "It's Official! ðŸŽ‰";
            btn.style.display = 'none';
            document.getElementById('statusNote').style.display = 'none';
        } else if (role === 's') {
            container.className = "container waiting-sender";
            title.innerText = "Pinky Extended...";
            btn.style.display = 'none';
            document.getElementById('statusNote').innerHTML = "Waiting for them to promise... ðŸ“¡";
        } else {
            container.className = "container invitation";
            title.innerText = `${currentPromise.sender_name} wants to promise...`;
            btn.style.display = 'inline-block';
            document.getElementById('statusNote').innerText = "Check the promise below â†“";
        }
        document.getElementById('promiseText').innerText = `"${currentPromise.promise_text}"`;
    }

    async function acceptPromise() {
        await supabaseClient.from('promises').update({ is_accepted: true }).eq('slug', currentPromise.slug);
        loadPromise();
    }

    function copyRecipientLink() {
        const urlParams = new URLSearchParams(window.location.search);
        const rLink = window.location.origin + "/promise/view.html?id=" + urlParams.get('id') + "&role=r";
        navigator.clipboard.writeText(rLink);
        alert("Copied! Send it to your friend.");
        document.getElementById('shareOverlay').style.display = 'none';
    }

    // Polling Loop
    const interval = setInterval(async () => {
        pollCount++;
        const stop = await loadPromise();
        if (stop || pollCount > 100) clearInterval(interval);
    }, 3000);

    loadPromise();
</script>
</body>
</html>
